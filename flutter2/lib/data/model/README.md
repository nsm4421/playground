# Table

```
CREATE TABLE PUBLIC."ACCOUNTS" (
    ID UUID NOT NULL,
    EMAIL TEXT NOT NULL UNIQUE,
    USERNAME TEXT NULL UNIQUE,
    AVATAR_URL TEXT NOT NULL,
    CONSTRAINT ACCOUNTS_PKEY PRIMARY KEY (ID),
    CONSTRAINT ACCOUNTS_FKEY FOREIGN KEY (ID) 
    REFERENCES AUTH.USERS (ID) ON UPDATE CASCADE ON DELETE CASCADE
) TABLESPACE PG_DEFAULT;

ALTER TABLE PUBLIC."ACCOUNTS" ENABLE ROW LEVEL SECURITY;

CREATE POLICY "PERMIT SELECT TO AUTHENTICATED" 
ON PUBLIC."ACCOUNTS" FOR SELECT USING (TRUE);

CREATE POLICY "PERMIT INSERT OWN DATA TO AUTHENTICATED" 
ON PUBLIC."ACCOUNTS" FOR INSERT TO AUTHENTICATED 
WITH CHECK (AUTH.UID() = ID);

CREATE POLICY "PERMIT UPDATE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."ACCOUNTS" FOR UPDATE TO AUTHENTICATED 
USING (AUTH.UID() = ID);

CREATE POLICY "PERMIT DELETE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."ACCOUNTS" FOR DELETE TO AUTHENTICATED 
USING (AUTH.UID() = ID);

------------------------------------------------------

CREATE TABLE PUBLIC."FEEDS" (
    ID UUID NOT NULL,
    HASHTAGS TEXT[] DEFAULT '{}',
    CAPTIONS TEXT[] DEFAULT '{}',
    IMAGES TEXT[] DEFAULT '{}', 
    -- meta data
    CREATED_BY UUID NOT NULL DEFAULT AUTH.UID(),
    CREATED_AT TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    UPDATED_AT TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    DELETED_AT TIMESTAMP WITH TIME ZONE DEFAULT NULL,
    CONSTRAINT FEEDS_PKEY PRIMARY KEY (ID),
    CONSTRAINT FEEDS_FKEY FOREIGN KEY (CREATED_BY) 
    REFERENCES PUBLIC."ACCOUNTS" (ID) ON UPDATE CASCADE ON DELETE CASCADE
) TABLESPACE PG_DEFAULT;

ALTER TABLE PUBLIC."FEEDS" ENABLE ROW LEVEL SECURITY;

CREATE POLICY "PERMIT SELECT TO AUTHENTICATED" 
ON PUBLIC."FEEDS" FOR SELECT TO AUTHENTICATED USING (TRUE);

CREATE POLICY "PERMIT INSERT OWN DATA TO AUTHENTICATED" 
ON PUBLIC."FEEDS" FOR INSERT TO AUTHENTICATED 
WITH CHECK (AUTH.UID() = CREATED_BY);

CREATE POLICY "PERMIT UPDATE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."FEEDS" FOR UPDATE TO AUTHENTICATED 
USING (AUTH.UID() = CREATED_BY);

CREATE POLICY "PERMIT DELETE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."FEEDS" FOR DELETE TO AUTHENTICATED 
USING (AUTH.UID() = CREATED_BY);

------------------------------------------------------

CREATE TABLE PUBLIC."REELS" (
    ID UUID NOT NULL,
    CAPTION TEXT,
    VIDEO TEXT NOT NULL, 
    -- meta data
    CREATED_BY UUID NOT NULL DEFAULT AUTH.UID(),
    CREATED_AT TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    UPDATED_AT TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    DELETED_AT TIMESTAMP WITH TIME ZONE DEFAULT NULL,
    CONSTRAINT REELS_PKEY PRIMARY KEY (ID),
    CONSTRAINT REELS_FKEY FOREIGN KEY (CREATED_BY) 
    REFERENCES PUBLIC."ACCOUNTS" (ID) ON UPDATE CASCADE ON DELETE CASCADE
) TABLESPACE PG_DEFAULT;

ALTER TABLE PUBLIC."REELS" ENABLE ROW LEVEL SECURITY;

CREATE POLICY "PERMIT SELECT TO AUTHENTICATED" 
ON PUBLIC."REELS" FOR SELECT TO AUTHENTICATED USING (TRUE);

CREATE POLICY "PERMIT INSERT OWN DATA TO AUTHENTICATED" 
ON PUBLIC."REELS" FOR INSERT TO AUTHENTICATED 
WITH CHECK (AUTH.UID() = CREATED_BY);

CREATE POLICY "PERMIT UPDATE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."REELS" FOR UPDATE TO AUTHENTICATED 
USING (AUTH.UID() = CREATED_BY);

CREATE POLICY "PERMIT DELETE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."REELS" FOR DELETE TO AUTHENTICATED 
USING (AUTH.UID() = CREATED_BY);

------------------------------------------------------

CREATE TABLE PUBLIC."COMMENTS" (
    ID UUID NOT NULL,
    PARENT_ID UUID,
    REFERENCE_ID UUID NOT NULL, 
    REFERENCE_TABLE TEXT NOT NULL,
    CONTENT TEXT NOT NULL,
    -- meta data
    CREATED_BY UUID NOT NULL DEFAULT AUTH.UID(),
    CREATED_AT TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    UPDATED_AT TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    DELETED_AT TIMESTAMP WITH TIME ZONE DEFAULT NULL,
    CONSTRAINT COMMENTS_PKEY PRIMARY KEY (ID),
    CONSTRAINT COMMENTS_FKEY FOREIGN KEY (CREATED_BY) 
    REFERENCES PUBLIC."ACCOUNTS" (ID) ON UPDATE CASCADE ON DELETE CASCADE
) TABLESPACE PG_DEFAULT;

ALTER TABLE PUBLIC."COMMENTS" ENABLE ROW LEVEL SECURITY;

CREATE POLICY "PERMIT SELECT TO AUTHENTICATED" 
ON PUBLIC."COMMENTS" FOR SELECT TO AUTHENTICATED USING (TRUE);

CREATE POLICY "PERMIT INSERT OWN DATA TO AUTHENTICATED" 
ON PUBLIC."COMMENTS" FOR INSERT TO AUTHENTICATED 
WITH CHECK (AUTH.UID() = CREATED_BY);

CREATE POLICY "PERMIT UPDATE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."COMMENTS" FOR UPDATE TO AUTHENTICATED 
USING (AUTH.UID() = CREATED_BY);

CREATE POLICY "PERMIT DELETE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."COMMENTS" FOR DELETE TO AUTHENTICATED 
USING (AUTH.UID() = CREATED_BY);

------------------------------------------------------

CREATE TABLE PUBLIC."EMOTIONS" (
    REFERENCE_ID UUID NOT NULL, 
    REFERENCE_TABLE TEXT NOT NULL,
    EMOTION TEXT NOT NULL,
    -- meta data
    CREATED_BY UUID NOT NULL DEFAULT AUTH.UID(),
    CREATED_AT TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT EMOTIONS_FKEY FOREIGN KEY (CREATED_BY) 
    REFERENCES PUBLIC."ACCOUNTS" (ID) ON UPDATE CASCADE ON DELETE CASCADE,
    UNIQUE(REFERENCE_ID, REFERENCE_TABLE)
) TABLESPACE PG_DEFAULT;

ALTER TABLE PUBLIC."EMOTIONS" ENABLE ROW LEVEL SECURITY;

CREATE POLICY "PERMIT SELECT TO AUTHENTICATED" 
ON PUBLIC."EMOTIONS" FOR SELECT TO AUTHENTICATED USING (TRUE);

CREATE POLICY "PERMIT INSERT OWN DATA TO AUTHENTICATED" 
ON PUBLIC."EMOTIONS" FOR INSERT TO AUTHENTICATED 
WITH CHECK (AUTH.UID() = CREATED_BY);

CREATE POLICY "PERMIT UPDATE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."EMOTIONS" FOR UPDATE TO AUTHENTICATED 
USING (AUTH.UID() = CREATED_BY);

CREATE POLICY "PERMIT DELETE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."EMOTIONS" FOR DELETE TO AUTHENTICATED 
USING (AUTH.UID() = CREATED_BY);

------------------------------------------------------

CREATE TABLE PUBLIC."PRIVATE_CHATS" (
    ID UUID NOT NULL,
    USER_ID UUID NOT NULL DEFAULT AUTH.UID(),
    OPPONENT_ID UUID NOT NULL,
    LAST_MESSAGE TEXT,
    LAST_SEEN TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CREATED_AT TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    UPDATED_AT TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    DELETED_AT TIMESTAMP WITH TIME ZONE DEFAULT NULL,
    CONSTRAINT PRIVATE_CHATS_PKEY PRIMARY KEY (ID, USER_ID),
    CONSTRAINT PRIVATE_CHATS_FKEY1 FOREIGN KEY (USER_ID) 
    REFERENCES PUBLIC."ACCOUNTS" (ID) ON UPDATE CASCADE ON DELETE CASCADE,
    CONSTRAINT PRIVATE_CHATS_FKEY2 FOREIGN KEY (OPPONENT_ID) 
    REFERENCES PUBLIC."ACCOUNTS" (ID) ON UPDATE CASCADE ON DELETE CASCADE
) TABLESPACE PG_DEFAULT;

ALTER TABLE PUBLIC."PRIVATE_CHATS" ENABLE ROW LEVEL SECURITY;

CREATE POLICY "PERMIT SELECT TO AUTHENTICATED" 
ON PUBLIC."PRIVATE_CHATS" FOR SELECT TO AUTHENTICATED USING 
(USER_ID = AUTH.UID());

CREATE POLICY "PERMIT INSERT OWN DATA TO AUTHENTICATED" 
ON PUBLIC."PRIVATE_CHATS" FOR INSERT TO AUTHENTICATED 
WITH CHECK ((AUTH.UID() = USER_ID) OR (AUTH.UID() = OPPONENT_ID));

CREATE POLICY "PERMIT UPDATE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."PRIVATE_CHATS" FOR UPDATE TO AUTHENTICATED 
USING ((AUTH.UID() = USER_ID) OR (AUTH.UID() = OPPONENT_ID));

CREATE POLICY "PERMIT DELETE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."PRIVATE_CHATS" FOR DELETE TO AUTHENTICATED 
USING (AUTH.UID() = USER_ID);

------------------------------------------------------

CREATE TABLE PUBLIC."PRIVATE_MESSAGES" (
    ID UUID NOT NULL,
    CHAT_ID UUID NOT NULL,
    SENDER_ID UUID NOT NULL DEFAULT AUTH.UID(),
    RECEIVER_ID UUID NOT NULL,
    CONTENT TEXT NOT NULL,
    TYPE TEXT DEFAULT 'text',
    CREATED_AT TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    UPDATED_AT TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    DELETED_AT TIMESTAMP WITH TIME ZONE DEFAULT NULL,
    CONSTRAINT PRIVATE_MESSAGES_PKEY PRIMARY KEY (ID),
    CONSTRAINT PRIVATE_MESSAGES_FKEY1 FOREIGN KEY (SENDER_ID) 
    REFERENCES PUBLIC."ACCOUNTS" (ID) ON UPDATE CASCADE ON DELETE CASCADE,
    CONSTRAINT PRIVATE_MESSAGES_FKEY2 FOREIGN KEY (RECEIVER_ID) 
    REFERENCES PUBLIC."ACCOUNTS" (ID) ON UPDATE CASCADE ON DELETE CASCADE
) TABLESPACE PG_DEFAULT;

ALTER TABLE PUBLIC."PRIVATE_MESSAGES" ENABLE ROW LEVEL SECURITY;

CREATE POLICY "PERMIT SELECT TO AUTHENTICATED" 
ON PUBLIC."PRIVATE_MESSAGES" FOR SELECT TO AUTHENTICATED USING 
((SENDER_ID = AUTH.UID()) OR (RECEIVER_ID = AUTH.UID()));

CREATE POLICY "PERMIT INSERT OWN DATA TO AUTHENTICATED" 
ON PUBLIC."PRIVATE_MESSAGES" FOR INSERT TO AUTHENTICATED 
WITH CHECK (SENDER_ID = AUTH.UID());

CREATE POLICY "PERMIT UPDATE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."PRIVATE_MESSAGES" FOR UPDATE TO AUTHENTICATED 
USING (SENDER_ID = AUTH.UID());

CREATE POLICY "PERMIT DELETE OWN DATA TO AUTHENTICATED"  
ON PUBLIC."PRIVATE_MESSAGES" FOR DELETE TO AUTHENTICATED 
USING (SENDER_ID = AUTH.UID());

```

# Bucket
```
insert into storage.buckets (id, name)
values ('avatars', 'avatars');

create policy "permit avatar for all" on storage.objects
for select using (bucket_id = 'avatars');

create policy "permit insert avatar for all" on storage.objects
for insert with check (bucket_id = 'avatars');

------------------------------------------------------

insert into storage.buckets (id, name)
values ('feeds', 'feeds');

create policy "permit feed media for all" on storage.objects
for select using (bucket_id = 'feeds');

create policy "permit insert feed media for all" on storage.objects
for insert with check (bucket_id = 'feeds');
------------------------------------------------------

insert into storage.buckets (id, name)
values ('reels', 'reels');

create policy "permit reels media for all" on storage.objects
for select using (bucket_id = 'reels');

create policy "permit insert reels media for all" on storage.objects
for insert with check (bucket_id = 'reels');
```